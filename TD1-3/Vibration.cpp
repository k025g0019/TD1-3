#include "Vibration.h"
#pragma comment(lib, "XInput.lib")

Vibration::Vibration(int idx)
    : index(idx), timer(0)
{
}

void Vibration::stop() {
    XINPUT_VIBRATION vib{};
    vib.wLeftMotorSpeed = 0;
    vib.wRightMotorSpeed = 0;
    XInputSetState(index, &vib);
}

void Vibration::play(WORD left, WORD right, int frames) {
    queue.push_back({ left, right, frames });
}

//==================================================
// ★ 毎フレーム振動進行（Sleepなし）
//==================================================
void Vibration::Update() {

    if (queue.empty()) {
        stop();
        return;
    }

    VibFrame& f = queue.front();

    XINPUT_VIBRATION vib;
    vib.wLeftMotorSpeed = f.left;
    vib.wRightMotorSpeed = f.right;
    XInputSetState(index, &vib);

    timer++;

    if (timer >= f.frames) {
        timer = 0;
        queue.erase(queue.begin());
    }
}

//==================================================
// ★ パターン開始
//==================================================
void Vibration::runPattern(VibrationPattern p) {
    queue.clear();
    timer = 0;
    loadPattern(p);
}

//==================================================
// ★ パターン定義（Sleep → frames に変換）
//==================================================
void Vibration::loadPattern(VibrationPattern p) {

    switch (p) {

        //----------------------------------------------------------------------
        // 1. メタン爆発（強→休→中強→弱フェード）
        //----------------------------------------------------------------------
        // Sleep(250) → 15F
        // Sleep(50)  → 3F
        // Sleep(200) → 12F
        // Sleep(30)  → 2F
        //----------------------------------------------------------------------
    case PATTERN_METAN_EXPLOSION:
        play(65000, 50000, 3);
        play(0, 0, 1);
        play(45000, 30000, 3);
        for (int i = 0; i < 5; i++) {
            int pwr = 15000 - i * 3000;
            if (pwr < 0) pwr = 0;
            play((WORD)pwr, (WORD)(pwr / 2), 1);
        }
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 2. 氷の巨人着地（強→弱）
        // Sleep(300)→18F / Sleep(100)→6F
        //----------------------------------------------------------------------
    case PATTERN_GIANT_LANDING:
        play(60000, 40000, 18);
        play(15000, 8000, 6);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 3. 突進→壁衝突
        //----------------------------------------------------------------------
        // 150ms→9F / 100ms→6F / 50ms→3F
        //----------------------------------------------------------------------
    case PATTERN_TACKLE_HIT_WALL:
        play(35000, 20000, 9);
        play(60000, 40000, 6);
        play(0, 0, 3);
        break;

        //----------------------------------------------------------------------
        // 4. 氷柱着弾
        // 120ms → 7F
        //----------------------------------------------------------------------
    case PATTERN_ICE_METEOR_HIT:
        play(35000, 20000, 7);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 5. 氷ブレス（50ms →3F / 10ms→1F）×5
        //----------------------------------------------------------------------
    case PATTERN_ICE_BREATH_HIT:
        for (int i = 0; i < 5; i++) {
            play(15000, 8000, 3);
            play(0, 0, 1);
        }
        break;

        //----------------------------------------------------------------------
        // 6. パンチ ／ひっかき （180ms→11F）
        //----------------------------------------------------------------------
    case PATTERN_CLAW_PUNCH:
        play(45000, 25000, 11);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 7. 氷片ばら撒き（80ms→5F）
        //----------------------------------------------------------------------
    case PATTERN_ICE_SCATTER_HIT:
        play(15000, 8000, 5);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 8. 落下穴（100ms→6F ×3）
        //----------------------------------------------------------------------
    case PATTERN_FALL_HOLE:
        play(12000, 6000, 6);
        play(30000, 15000, 6);
        play(50000, 25000, 6);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 9. 爆風ダメージ（180ms→11F / 100ms→6F）
        //----------------------------------------------------------------------
    case PATTERN_EXPLOSION_DAMAGE:
        play(60000, 40000, 11);
        play(35000, 20000, 6);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 10. ピッケル（50ms→3F / 20ms→1F）
        //----------------------------------------------------------------------
    case PATTERN_PICKAXE_BREAK:
        play(15000, 8000, 3);
        play(0, 0, 1);
        play(15000, 8000, 3);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 11. 氷の巨人の足音（100ms→6F）
        //----------------------------------------------------------------------
    case PATTERN_GIANT_FOOTSTEP:
        play(35000, 20000, 6);
        play(0, 0, 1);
        break;

        //----------------------------------------------------------------------
        // 12. メタン吸引（40ms→2F / 20ms→1F）×5
        //----------------------------------------------------------------------
    case PATTERN_METAN_SUCTION:
        for (int i = 0; i < 5; i++) {
            play(15000, 8000, 2);
            play(0, 0, 1);
        }
        break;

        //----------------------------------------------------------------------
        // 13. 撃破（200ms→12F / 150ms→9F / 150ms→9F / 40ms→2F×5）
        //----------------------------------------------------------------------
    case PATTERN_BOSS_COLLAPSE:
        play(60000, 40000, 2);
        play(35000, 20000, 1);
        play(15000, 8000, 1);
        for (int i = 0; i < 3; i++) {
            int pwr = 15000 - i * 3000;
            if (pwr < 0) pwr = 0;
            play((WORD)pwr, (WORD)(pwr / 2), 1);
        }
        play(0, 0, 1);
        break;
        //----------------------------------------------------------------------
    case PATTERN_PLAYER_DEATH:
        // 1. 強い衝撃
        play(60000, 45000, 6);

        // 2. 力が抜けた瞬間（完全停止）
        play(0, 0, 3);

        // 3. 弱くフェード（3段階）
        play(20000, 12000, 1);
        play(10000, 6000, 1);
        play(5000, 3000, 1);

        // 終了
        play(0, 0, 1);
        break;
    default:
        play(0, 0, 1);
        break;
    }
}
